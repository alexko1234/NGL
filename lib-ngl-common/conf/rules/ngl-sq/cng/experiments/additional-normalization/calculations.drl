package rules

// 19/07/2017 Copie de lib-normalization...
rule "Debug additional-normalization"
	@nglSQ( calculations )
	dialect "java"
	salience 1000
	no-loop
    when
		$experiment:Experiment($typeCode:typeCode,$typeCode=="additional-normalization")
    eval(true)
    then
		Logger.debug("Rules annotation @nglSQ(calculations) additional-normalization");    
end

// calcul du volume engagé et du tampon
rule "InputVolume in additional-normalization inputContainer"
    @nglSQ( calculations )
	dialect "java"
	salience 920
	no-loop
    when
		$experiment:Experiment($typeCode:typeCode,$typeCode=="additional-normalization")
		$atomicTransfert: OneToOneContainer($inputContainerUsed:inputContainerUseds.get(0), $outputContainerUsed: outputContainerUseds.get(0))	
		
		// !! pb pas de concentration input tant qu'on a pas fait la Quantification!!! ....
		InputContainerUsed($inputConcentration: concentration, $inputConcentration!=null ) from $inputContainerUsed
		InputContainerUsed($inputVolume: volume, $inputVolume!=null ) from $inputContainerUsed
		
		OutputContainerUsed($outputVolume: volume, $outputVolume!=null ) from $outputContainerUsed
		OutputContainerUsed($outputConcentration: concentration, $outputConcentration!=null ) from $outputContainerUsed
		
		// cas 0 OK et cas pas de valeur OK ( volontairement ou avec valeur non numerique)
	    eval ( $outputVolume.value != null && convertPVToDouble($outputVolume) != 0 )
        eval ( $outputConcentration.value != null && convertPVToDouble($outputConcentration) != 0 )
        // NGL-981:25/04/2016 attention si inputConcentration=0 --> division par 0
        eval ( $inputConcentration.value != null && convertPVToDouble($inputConcentration) != 0 )
        
   then
   		Double engVolume = 0.0;
   		Double bfVolume = 0.0;
   		Double inputConcentration = 0.0;
   		
        // 25/07/2017 suite a l'ajout de additionnal-normalization=> remise a plat:  
        // si concentration OUT > concentration IN : inutile d'essayer de faire des calculs
        //    => conc Out= conc IN, buffer=0, vol engagé=vol input
        
		if ( convertPVToDouble($outputConcentration) > convertPVToDouble($inputConcentration) ){	
			Logger.debug("Warning: concentration demandée > initiale ");
			
			Logger.debug("set output concentration to input concentration :"+inputConcentration );
	 	    $outputContainerUsed.concentration= $atomicTransfert.inputContainerUseds.get(0).getConcentration();
		    
		    if ($inputContainerUsed.experimentProperties !=null && $inputContainerUsed.experimentProperties.containsKey("inputVolume")){
		    	engVolume=convertPVToDouble($inputContainerUsed.experimentProperties.get("inputVolume"));
		    	Logger.debug("set engVolume to inputVolume :"+ engVolume);
		    } 
		    // else  si pas de inputVolume on ne peut pas recuperer sa valeur !!  
		    
	    } else {
	    
	    	// -1- calcul volume engagé
        	Logger.debug("-1- volume engagé");  
        	Logger.debug("inputConcentration="+ Double.parseDouble($inputConcentration.getValue().toString()) );

       		engVolume = roundValue(convertPVToDouble($outputConcentration)*convertPVToDouble($outputVolume)/convertPVToDouble($inputConcentration));
        	Logger.debug("engVolume="+ engVolume );
        
		   // -2- calcul volume de tampon : volume buffer= volume out - volume engagé
			Logger.debug("-2- volume tampon= volume out - volume engagé");
			
			bfVolume = roundValue(convertPVToDouble($outputVolume) - engVolume );
		    Logger.debug("bufferVolume="+bfVolume);
		}
		
		PropertySingleValue psvEngVolume = new PropertySingleValue(engVolume, "\u00B5L");
        PropertySingleValue psvBufferVol = new PropertySingleValue(bfVolume, "\u00B5L");
        
        if($inputContainerUsed.experimentProperties==null){
			$inputContainerUsed.experimentProperties = new HashMap<String, PropertyValue>();		
		}else if($inputContainerUsed.experimentProperties.containsKey("bufferVolume")){
			$inputContainerUsed.experimentProperties.remove("bufferVolume");
		}	
	   	$inputContainerUsed.experimentProperties.put("bufferVolume", psvBufferVol);	
	   		
	   	if($inputContainerUsed.experimentProperties==null){
			  $inputContainerUsed.experimentProperties = new HashMap<String, PropertyValue>();		
		}else if($inputContainerUsed.experimentProperties.containsKey("inputVolume")){
			   $inputContainerUsed.experimentProperties.remove("inputVolume");
		}	
	    $inputContainerUsed.experimentProperties.put("inputVolume", psvEngVolume);
	    	    
		update($experiment);
end