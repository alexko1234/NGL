//created on: May 5, 2015
package rules



rule "Output Values"
    @nglSQ( calculations )
	dialect "java"
	salience 1000
	no-loop
    when
		$experiment:Experiment($typeCode:typeCode,$typeCode=="pool-tube")
		$atomicTransfert: ManyToOneContainer($inputContainerUseds : inputContainerUseds, $inputContainerUseds!=null , $outputContainerUsed: outputContainerUseds[0], $outputContainerUsed!=null )
	then
		Integer in;
		Double libV;
		Double poolV = 0.0;
		PropertySingleValue volumelib;
		Double qteTotal = 0.0;
		PropertySingleValue concOut;
		PropertySingleValue totalVolume;
		for(in = 0; in<$inputContainerUseds.size(); in++){
			InputContainerUsed inputContainerUsed = (InputContainerUsed) $inputContainerUseds.get(in);
			if(inputContainerUsed.concentration!=null && inputContainerUsed.experimentProperties != null && inputContainerUsed.experimentProperties.get("qte_finale_lib")!=null){
				libV = convertPVToDouble(inputContainerUsed.experimentProperties.get("qte_finale_lib"))/convertPVToDouble(inputContainerUsed.concentration);
				volumelib = new PropertySingleValue(libV,"\u00B5L");
				if(inputContainerUsed.experimentProperties.get("vol_finale_lib") != null){
		   			inputContainerUsed.experimentProperties.remove("vol_finale_lib");
		   		} 
		   		inputContainerUsed.experimentProperties.put("vol_finale_lib",volumelib);  
				poolV = poolV + libV;
				Logger.debug("InputVolume calculation - " + volumelib.value + " pour " + inputContainerUsed.code + " -> total : " + poolV);
				qteTotal = qteTotal + convertPVToDouble(inputContainerUsed.experimentProperties.get("qte_finale_lib"));
				Logger.debug("qteTotal - " + qteTotal);
			}
		}
		if($outputContainerUsed.getVolume() != null){
			totalVolume = new PropertySingleValue(poolV,"\u00B5L");
			$outputContainerUsed.setVolume(totalVolume);
			Logger.debug("Not OutputVolumeTotal " + totalVolume.getValue());
		}
		
		if($outputContainerUsed.getConcentration() != null){
			concOut = new PropertySingleValue(qteTotal/poolV,"nM");
			$outputContainerUsed.setConcentration(concOut);
			//Logger.debug("Not OutputVolumeTotal " + totalVolume.getConcentration());
		}
    	update($experiment);
	end


